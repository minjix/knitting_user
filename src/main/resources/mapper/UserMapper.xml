<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.knitting.user.mapper.UserMapper">

    <!-- insertUser: PK(user_id) 자동 생성 후 user.userId에 채워짐 -->
    <insert id="insertUser" parameterType="com.knitting.user.domain.UserEntity"
            useGeneratedKeys="true" keyProperty="userId">
        INSERT INTO KNIT_USERS (
            USER_NAME,
            LOGIN_ID,
            PASSWORD,
            BIRTHDATE,
            ROLE,
            IS_LOCKED,
            CREATED_AT,
            UPDATED_AT
        )
        VALUES (
            #{userName}
            #{loginId},
            #{password},
            #{birthdate},
            'ROLE_USER',
            0,
            sysdate(),
            sysdate()
        )
    </insert>

    <!-- findByLoginId: 자동 매핑 (login_id → loginId, user_name → userName) -->
    <select id="findByLoginId" resultType="com.example.demo.domain.User" parameterType="string">
        SELECT
            USER_ID,
            LOGIN_ID,
            PASSWORD,
            USER_NAME,
            BIRTHDAY,
            INS_DT,
            UPD_DT
        FROM KNIT_USERS
        WHERE LOGIN_ID = #{loginId}
    </select>

    <!-- findRolesByLoginId: roles 테이블과 user_roles 조인 -->
    <select id="findRolesByLoginId" resultType="string" parameterType="string">
        SELECT R.NAME
          FROM ROLES R
          JOIN USER_ROLES UR ON R.ROLE_ID = UR.ROLE_ID
          JOIN KNIT_USERS U ON U.USER_ID = UR.USER_ID
         WHERE U.LOGIN_ID = #{loginId}
    </select>

</mapper>